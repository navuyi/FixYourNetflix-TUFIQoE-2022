(()=>{"use strict";const e={experiment_settings:{stats_record_interval_ms:1e3,bitrate_change_interval_ms:1e5,bitrate_change_jitter_ms:15e3,quality_increase_rewind:3e3,video_url:["https://www.netflix.com/watch/80200571"],subject_age:0,subject_sex:"",subject_netflix_familiarity:"",subject_selected_content:"",content_continuation:""},experiment_variables:{database_experiment_id:-1,database_video_id:-1,video_index:0,experiment_running:!1}},t=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}T${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")}`;class i{constructor(e,i="white"){this.log=e=>{const i=`${this.prefix} | ${t(new Date)} |`;this.original_logger(`${i} %c ${e}`,`color: ${this.color}`)},this.prefix=e,this.color=i,this.original_logger=console.log}}class a{}a.logger=new i("ChromeStorage"),a.initialize_default=async()=>{a.logger.log("Initializing default storage"),await chrome.storage.local.set(e)},a.set_single=async(e,t)=>{await chrome.storage.local.set({[e]:t})},a.get_single=async e=>(await chrome.storage.local.get([e]))[e],a.get_multiple=async(...e)=>await chrome.storage.local.get([...e]),a.get_experiment_variables=async()=>await a.get_single("experiment_variables"),a.set_experiment_variables=async e=>{await chrome.storage.local.set({experiment_variables:e})},a.get_experiment_settings=async()=>await a.get_single("experiment_settings"),a.set_experiment_settings=async e=>{await chrome.storage.local.set({experiment_settings:e})};const r="finished",n="redirect";chrome.runtime.onInstalled.addListener((async()=>{console.log(`[BackgroundScript] | ${t(new Date)} | Installing...`),await a.initialize_default(),chrome.declarativeNetRequest.updateDynamicRules({addRules:[{id:1,priority:1,action:{type:"redirect",redirect:{extensionPath:"/cadmiumPlayercore.bundle.js"}},condition:{urlFilter:"*://assets.nflxext.com/*/ffe/player/html/*",resourceTypes:["script"]}},{id:2,priority:1,action:{type:"redirect",redirect:{extensionPath:"/cadmiumPlayercore.bundle.js"}},condition:{urlFilter:"*://www.assets.nflxext.com/*/ffe/player/html/*",resourceTypes:["script"]}}],removeRuleIds:[1,2,3,4]},(()=>{}))})),chrome.action.onClicked.addListener((async e=>{e&&e.id&&await chrome.tabs.update(e.id,{url:"setup.html"})})),chrome.runtime.onMessage.addListener(((e,t,i)=>(s(e,t,i),o(e,t,i),!0)));(new class{constructor(){this.NETFLIX_WATCH_URL="https://www.netflix.com/watch",this.init=async()=>{this.logger.log("Initializing..."),this.listenForVideoStart()},this.increaseVideoCount=async()=>{const e=await a.get_experiment_variables();e.video_index+=1,this.logger.log(`Increasing video count to ${e.video_index}`),await a.set_experiment_variables(e)},this.listenForVideoStart=()=>{chrome.webNavigation.onCompleted.addListener((e=>{0===e.frameId&&e.url.includes(this.NETFLIX_WATCH_URL)&&chrome.tabs.get(e.tabId,(async t=>{t.url===e.url&&(this.logger.log("Entered Netflix Video Player"),await this.injectScript(e.tabId))}))}))},this.logger=new i("[Controller]")}async injectScript(e){!1!==(await a.get_experiment_variables()).experiment_running?(await chrome.scripting.executeScript({target:{tabId:e},files:["content.bundle.js"]}),this.logger.log("ContentScript has been injected")):this.logger.log("Extension is not running.")}}).init();const s=async(e,t,i)=>{if(e.header===r&&t.tab){const e=t.tab.id;await chrome.tabs.update(e,{url:"break.html"}),i({msg:"Finish signal received"})}},o=async(e,t,i)=>{if(e.header===n&&t.tab){const a=t.tab.id;await chrome.tabs.update(a,{url:e.data.url}),i({msg:"Redirect signal received"})}}})();